<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDAW: Studio Pro</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #252526;
            --header-bg: #333333;
            --border-color: #444;
            --accent: #00cc99;
            --text-main: #cccccc;
            --track-bg: #2d2d30;
            --timeline-bg: #181818;
            --danger: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- TOP BAR --- */
        .transport-bar {
            height: 60px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 20px; gap: 15px;
            z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .brand { font-weight: bold; font-size: 1.2rem; color: #fff; margin-right: 15px; letter-spacing: 1px; }
        
        .transport-controls { display: flex; gap: 5px; background: #1a1a1a; padding: 4px; border-radius: 4px; border:1px solid #444; }
        .btn-transport {
            background: #333; border: none; color: #eee; width: 40px; height: 35px; border-radius: 3px; cursor: pointer; transition: background 0.2s; font-size: 1.1rem;
        }
        .btn-transport:hover:not(:disabled) { background: #555; }
        .btn-transport.active { background: var(--accent); color: #000; font-weight:bold; }
        .btn-transport.loop.active { background: #f1c40f; color: #000; }
        .btn-transport:disabled { opacity: 0.3; cursor: not-allowed; }

        .lcd-display {
            background: #000; color: var(--accent); padding: 0 15px; border-radius: 3px; border: 1px solid #555;
            display: flex; flex-direction: column; justify-content: center; height: 35px; min-width: 90px;
        }
        .lcd-val { font-size: 1.1rem; font-weight: bold; text-align: center; font-family: 'Courier New', Courier, monospace; }
        .lcd-label { font-size: 0.6rem; color: #555; text-align: center; text-transform: uppercase; }

        /* Download Button (Top Right) */
        .btn-download {
            margin-left: auto;
            background: #007acc; color: white; border: none; padding: 0 20px; height: 35px;
            border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .btn-download:hover { background: #006bb3; }
        .btn-download.recording { background: var(--danger); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- WORKSPACE --- */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar {
            width: 280px; background: var(--panel-bg); border-right: 1px solid var(--border-color);
            padding: 15px; display: flex; flex-direction: column; gap: 15px; z-index: 15; overflow-y: auto;
        }
        .panel-box { background: #1e1e1e; padding: 15px; border-radius: 6px; border: 1px solid #3e3e3e; }
        .panel-label { font-size:0.7rem; font-weight:bold; color:#888; margin-bottom:8px; display: block; text-transform: uppercase; }
        
        .btn-file {
            border: 2px dashed #555; color: #aaa; background: transparent; padding: 20px; width: 100%; cursor: pointer; border-radius: 6px; transition: all 0.2s;
        }
        .btn-file:hover { border-color: var(--accent); color: var(--accent); }
        input[type="file"] { display: none; }

        .control-group { margin-bottom: 10px; }
        .control-flex { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #aaa; margin-bottom: 4px;}
        input[type=range] { width: 100%; cursor: pointer; }

        /* --- TIMELINE & TRACKS --- */
        .timeline-scroll-container {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            position: relative; background: var(--timeline-bg);
        }
        
        .track-container { position: relative; padding-top: 30px; }

        .timeline-ruler {
            position: absolute; top: 0; left: 280px; right: 0; height: 30px;
            background: #1a1a1a; border-bottom: 1px solid #444; z-index: 10;
            display: flex; align-items: flex-end; cursor: pointer;
        }
        .ruler-tick { flex: 1; border-left: 1px solid #333; height: 10px; font-size: 0.6rem; color: #666; padding-left: 4px; pointer-events: none; }
        .controls-header {
            position: absolute; top: 0; left: 0; width: 280px; height: 30px;
            background: var(--panel-bg); border-bottom: 1px solid #444; border-right: 1px solid #444;
            display: flex; align-items: center; padding-left: 10px; font-size: 0.75rem; font-weight: bold; color: #888; z-index: 11;
        }

        /* Track Row */
        .track-row { display: flex; height: 110px; border-bottom: 1px solid #333; position: relative; }

        .track-controls {
            width: 280px; min-width: 280px; background: var(--track-bg); padding: 10px;
            border-right: 1px solid #444; border-left: 4px solid #555;
            display: flex; flex-direction: column; justify-content: space-between;
            position: sticky; left: 0; z-index: 5;
        }
        .track-lane {
            flex: 1; position: relative; background-image: linear-gradient(#222 1px, transparent 1px); background-size: 100% 12px;
            cursor: crosshair;
        }
        .note-rect {
            position: absolute; background: var(--accent); opacity: 0.7; height: 8px; border-radius: 2px; pointer-events: none;
        }

        .track-name { font-weight: bold; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; }
        .track-tools { display: flex; gap: 5px; margin-top: 5px; }
        .mini-btn {
            background: #111; border: 1px solid #444; color: #888; border-radius: 3px; 
            font-size: 0.7rem; cursor: pointer; width: 25px; height: 25px;
        }
        .mini-btn.mute.active { background: #c0392b; color: white; border-color: #c0392b; }
        
        select { background: #111; color: #ddd; border: 1px solid #444; padding: 4px; width: 100%; border-radius:3px; font-size: 0.8rem; }
        .loading-spinner { font-size: 0.7rem; color: #f1c40f; display: none; margin-left: 5px; }
        .loading-spinner.show { display: inline; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Mixer Controls */
        .mix-row { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color:#888; margin-top: 2px;}
        .mix-row label { width: 25px; }
        .mix-row input { flex:1; }

        /* Playhead */
        .timeline-overlay-container {
            position: absolute; top: 30px; left: 280px; bottom: 0; right: 0;
            pointer-events: none; z-index: 20;
        }
        #playhead {
            position: absolute; top: 0; bottom: 0; width: 1px; background: #fff;
            left: 0; box-shadow: 0 0 5px rgba(255,255,255,0.8); display: none;
        }
        #playhead-cap {
            position: absolute; top: -10px; left: -5px; width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 10px solid #fff;
        }

        #status-overlay {
            position: fixed; bottom: 20px; right: 20px; background: #333; padding: 12px 24px;
            border-radius: 4px; color: white; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s;
            border-left: 4px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100;
        }
        #status-overlay.show { opacity: 1; }

    </style>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/tone@13.8.25/build/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="Tonejs-Instruments.js"></script> <!-- Ensure this exists locally for sampled instruments -->
</head>
<body>

<header class="transport-bar">
    <div class="brand">WebDAW <span style="font-weight:300; color:#777;">Studio Pro</span></div>
    
    <div class="transport-controls">
        <button id="stopBtn" class="btn-transport" title="Stop">■</button>
        <button id="playBtn" class="btn-transport" title="Play">▶</button>
        <button id="loopBtn" class="btn-transport loop" title="Toggle Loop">↻</button>
    </div>
    
    <div class="lcd-display">
        <div class="lcd-label">TIME</div>
        <div class="lcd-val" id="timeDisplay">0:00</div>
    </div>

    <div class="lcd-display">
        <div class="lcd-label">BPM</div>
        <div class="lcd-val" id="bpmDisplay">120</div>
    </div>

    <!-- Export Button -->
    <button id="dlBtn" class="btn-download" disabled>
        <span>↓</span> Export Audio
    </button>
</header>

<div class="workspace">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="panel-box">
            <div class="panel-label">PROJECT FILE</div>
            <button class="btn-file" id="fileBtn">Load MIDI</button>
            <input type="file" id="midiInput" accept=".mid,.midi">
            <div id="fileName" style="margin-top:10px; font-size:0.75rem; color:#666; text-align:center; overflow:hidden; text-overflow:ellipsis;">No file</div>
        </div>

        <div class="panel-box">
            <div class="panel-label">MASTER FX</div>
            
            <div class="control-group">
                <div class="control-flex"><span>Speed</span> <span id="speedVal">1.0x</span></div>
                <input type="range" id="speedInput" min="0.5" max="1.5" step="0.05" value="1.0">
            </div>

            <div class="control-group">
                <div class="control-flex"><span>Reverb</span> <span id="reverbVal">20%</span></div>
                <input type="range" id="reverbInput" min="0" max="0.6" step="0.05" value="0.2">
            </div>
        </div>
    </div>

    <!-- TIMELINE -->
    <div class="timeline-scroll-container" id="timelineScroll">
        
        <!-- Fixed Headers -->
        <div class="controls-header">TRACK CONTROLS</div>
        <div class="timeline-ruler" id="timeRuler"></div>

        <div class="track-container" id="trackContainer"></div>
        
        <!-- Playhead -->
        <div class="timeline-overlay-container">
            <div id="playhead"><div id="playhead-cap"></div></div>
        </div>
    </div>
</div>

<div id="status-overlay">Ready.</div>

<script>
    // --- CONFIG & CONSTANTS ---
    // Ensure Tonejs-Instruments knows where samples are
    if (typeof SampleLibrary !== 'undefined') {
        SampleLibrary.baseUrl = "./samples/"; 
    }
    
    // Fallback list if library isn't loaded
    const INSTRUMENT_LIST = (typeof SampleLibrary !== 'undefined') 
        ? SampleLibrary.list 
        : ['piano', 'bass-electric', 'guitar-acoustic']; 

    // --- STATE ---
    let midiData = null;
    let isPlaying = false;
    let isLooping = false;
    let animationId;
    let activeTracks = []; 
    let originalBpm = 120;

    // --- AUDIO NODES ---
    // Master Reverb connected to Master Output
    const masterReverb = new Tone.Freeverb({roomSize: 0.2, dampening: 3000}).toMaster();
    
    // --- DOM ELEMENTS ---
    const els = {
        midiInput: document.getElementById('midiInput'),
        fileBtn: document.getElementById('fileBtn'),
        trackContainer: document.getElementById('trackContainer'),
        playBtn: document.getElementById('playBtn'),
        stopBtn: document.getElementById('stopBtn'),
        loopBtn: document.getElementById('loopBtn'),
        dlBtn: document.getElementById('dlBtn'),
        playhead: document.getElementById('playhead'),
        timeDisplay: document.getElementById('timeDisplay'),
        bpmDisplay: document.getElementById('bpmDisplay'),
        speedInput: document.getElementById('speedInput'),
        reverbInput: document.getElementById('reverbInput'),
        speedVal: document.getElementById('speedVal'),
        reverbVal: document.getElementById('reverbVal'),
        timeRuler: document.getElementById('timeRuler'),
        timelineScroll: document.getElementById('timelineScroll')
    };

    // --- LISTENERS ---
    els.fileBtn.addEventListener('click', () => els.midiInput.click());

    els.reverbInput.oninput = (e) => {
        masterReverb.roomSize.value = e.target.value;
        els.reverbVal.innerText = Math.round(e.target.value * 100) + "%";
    };

    els.speedInput.oninput = (e) => {
        const val = parseFloat(e.target.value);
        els.speedVal.innerText = val + "x";
        if(midiData) Tone.Transport.bpm.value = originalBpm * val;
        els.bpmDisplay.innerText = Math.round(Tone.Transport.bpm.value);
    };

    els.loopBtn.addEventListener('click', () => {
        isLooping = !isLooping;
        els.loopBtn.classList.toggle('active', isLooping);
        Tone.Transport.loop = isLooping;
    });

    // Scrubbing Logic
    els.timeRuler.addEventListener('mousedown', scrubTimeline);
    els.trackContainer.addEventListener('mousedown', (e) => {
        if(e.target.closest('.track-lane')) scrubTimeline(e);
    });

    function scrubTimeline(e) {
        if(!midiData) return;
        const rect = els.timeRuler.getBoundingClientRect();
        const offsetX = e.clientX - rect.left; 
        const width = rect.width;
        const percent = Math.max(0, Math.min(1, offsetX / width));
        
        const jumpTime = midiData.duration * percent;
        Tone.Transport.seconds = jumpTime;
        els.playhead.style.left = (percent * 100) + '%';
        if(!isPlaying) updateTimeDisplay();
    }

    // --- 1. FILE LOADING ---
    els.midiInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (isPlaying) stopPlayback();
        cleanupTracks();
        showStatus("Parsing MIDI...");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                midiData = new Midi(e.target.result);
                document.getElementById('fileName').textContent = file.name;
                
                // Setup Transport
                originalBpm = midiData.header.tempos.length > 0 ? midiData.header.tempos[0].bpm : 120;
                Tone.Transport.bpm.value = originalBpm;
                Tone.Transport.loopStart = 0;
                Tone.Transport.loopEnd = midiData.duration;
                Tone.Transport.loop = isLooping;
                
                els.bpmDisplay.innerText = Math.round(originalBpm);

                renderUI();
                showStatus("Loaded successfully.");
                
                els.playBtn.disabled = false;
                els.stopBtn.disabled = false;
                els.dlBtn.disabled = false;
            } catch(err) {
                console.error(err);
                showStatus("Error parsing MIDI file.");
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function cleanupTracks() {
        activeTracks.forEach(t => {
            if(t.synth) t.synth.dispose();
            if(t.part) t.part.dispose();
            if(t.panVol) t.panVol.dispose();
        });
        activeTracks = [];
        els.trackContainer.innerHTML = '';
    }

    // --- 2. RENDER UI ---
    function renderUI() {
        const duration = midiData.duration;
        
        // Draw Ruler Ticks
        els.timeRuler.innerHTML = '';
        for(let i=0; i<=10; i++) {
            let tick = document.createElement('div');
            tick.className = 'ruler-tick';
            tick.style.borderLeft = i === 0 ? 'none' : '1px solid #333';
            // Format time label (MM:SS)
            tick.innerText = i === 0 ? '' : new Date((duration/10 * i) * 1000).toISOString().substr(14, 5);
            els.timeRuler.appendChild(tick);
        }

        // Build Instrument Dropdown Options
        let options = `<option value="synth_triangle">Synth: Triangle</option>
                       <option value="synth_saw">Synth: Sawtooth</option>`;
        INSTRUMENT_LIST.forEach(inst => {
            options += `<option value="${inst}">Real: ${inst.charAt(0).toUpperCase() + inst.slice(1)}</option>`;
        });

        // Render Tracks
        midiData.tracks.forEach((track, index) => {
            if (track.notes.length === 0) return; // Skip empty tracks

            // Intelligent Instrument Selection
            let defaultInst = 'synth_triangle';
            INSTRUMENT_LIST.forEach(inst => {
                if(track.instrument.name.toLowerCase().includes(inst)) defaultInst = inst;
            });
            if (track.instrument.percussion || track.channel === 9) defaultInst = 'synth_saw'; 

            // Create Channel Strip (PanVol -> MasterReverb)
            const panVol = new Tone.PanVol(0, -5).connect(masterReverb);

            activeTracks[index] = {
                synth: null, 
                panVol: panVol, 
                part: null,
                notes: track.notes,
                name: track.name || `Track ${index + 1}`
            };

            // Render Note Blocks
            let notesHtml = '';
            track.notes.forEach(note => {
                const left = (note.time / duration) * 100;
                const width = (note.duration / duration) * 100;
                // Normalize pitch (approx range 24-100) for visual height
                const top = 100 - ((note.midi - 24) / 80) * 100;
                notesHtml += `<div class="note-rect" style="left:${left}%; width:${width}%; top:${top}%;"></div>`;
            });

            const row = document.createElement('div');
            row.className = 'track-row';
            row.innerHTML = `
                <div class="track-controls">
                    <div class="track-name">${index+1}. ${activeTracks[index].name}</div>
                    <div class="track-tools">
                        <button class="mini-btn mute" onclick="toggleMute(${index}, this)">M</button>
                        <select id="sel-${index}" onchange="changeInstrument(${index}, this.value)">${options}</select>
                    </div>
                    <span class="loading-spinner" id="load-${index}">Loading...</span>
                    
                    <div class="mix-row">
                        <label>Vol</label>
                        <input type="range" min="-60" max="0" value="-5" oninput="changeVol(${index}, this.value)">
                    </div>
                    <div class="mix-row">
                        <label>Pan</label>
                        <input type="range" min="-1" max="1" step="0.1" value="0" oninput="changePan(${index}, this.value)">
                    </div>
                </div>
                <div class="track-lane">
                    ${notesHtml}
                </div>
            `;
            els.trackContainer.appendChild(row);
            
            // Initialize Instrument
            document.getElementById(`sel-${index}`).value = defaultInst;
            changeInstrument(index, defaultInst); 
        });
    }

    // --- 3. INSTRUMENT LOGIC ---
    window.changeInstrument = async function(index, type) {
        const spinner = document.getElementById(`load-${index}`);
        spinner.classList.add('show');
        
        const trackState = activeTracks[index];

        try {
            const newInst = await createInstrument(type);
            // Connect new instrument to channel strip
            newInst.connect(trackState.panVol);

            if(trackState.synth) trackState.synth.dispose();
            trackState.synth = newInst;

            // Re-create the Part sequence
            if(trackState.part) trackState.part.dispose();
            createPart(index);

        } catch(e) {
            console.error(e);
            showStatus("Failed to load sample. Using Synth.");
            // Fallback logic could go here
        } finally {
            spinner.classList.remove('show');
        }
    }

    function createInstrument(type) {
        return new Promise(resolve => {
            if(type.startsWith('synth')) {
                const t = type.split('_')[1];
                const poly = new Tone.PolySynth(6, Tone.Synth);
                poly.set({ oscillator: { type: t }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 } });
                resolve(poly);
            } else {
                // Uses Tonejs-Instruments library
                if (typeof SampleLibrary === 'undefined') {
                    // Fallback if script missing
                    resolve(new Tone.PolySynth(4, Tone.Synth));
                    return;
                }
                
                var sampler = SampleLibrary.load({
                    instruments: type,
                    onload: () => resolve(sampler)
                });
            }
        });
    }

    function createPart(index) {
        const trackState = activeTracks[index];
        
        // Tone.Part schedules events efficiently
        const part = new Tone.Part((time, note) => {
            if(trackState.synth && !trackState.panVol.mute) {
                trackState.synth.triggerAttackRelease(note.name, note.duration, time, note.velocity);
            }
        }, trackState.notes.map(n => ({
            time: n.time, name: n.name, duration: n.duration, velocity: n.velocity
        })));
        
        part.start(0);
        trackState.part = part;
    }

    // --- 4. TRACK CONTROLS ---
    window.toggleMute = function(index, btn) {
        const node = activeTracks[index].panVol;
        node.mute = !node.mute;
        btn.classList.toggle('active', node.mute);
    }

    window.changeVol = function(index, val) {
        activeTracks[index].panVol.volume.value = parseFloat(val);
    }

    window.changePan = function(index, val) {
        activeTracks[index].panVol.pan.value = parseFloat(val);
    }

    // --- 5. TRANSPORT & PLAYBACK ---
    els.playBtn.addEventListener('click', async () => {
        if (isPlaying) return;
        await Tone.start(); // Browser audio context start
        Tone.Transport.start();
        isPlaying = true;
        els.playBtn.classList.add('active');
        els.playhead.style.display = 'block';
        animate();
    });

    els.stopBtn.addEventListener('click', stopPlayback);

    function stopPlayback() {
        Tone.Transport.stop();
        isPlaying = false;
        els.playBtn.classList.remove('active');
        els.playhead.style.display = 'none';
        cancelAnimationFrame(animationId);
        updateTimeDisplay();
    }

    function animate() {
        if(!isPlaying) return;
        const progress = Tone.Transport.seconds / midiData.duration;
        let visProgress = progress;
        
        if(isLooping) visProgress = (Tone.Transport.seconds % midiData.duration) / midiData.duration;

        // Stop if end reached and not looping
        if(visProgress >= 1 && !isLooping) {
            stopPlayback();
            return;
        }

        els.playhead.style.left = (visProgress * 100) + '%';
        updateTimeDisplay();
        animationId = requestAnimationFrame(animate);
    }

    function updateTimeDisplay() {
        const s = Tone.Transport.seconds;
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        els.timeDisplay.textContent = `${m}:${sec.toString().padStart(2,'0')}`;
    }

    // --- 6. EXPORT ---
    els.dlBtn.addEventListener('click', async () => {
        if(isPlaying) stopPlayback();
        
        await Tone.start();
        
        // Setup Recorder
        const recorder = new Tone.Recorder();
        Tone.Master.connect(recorder);

        showStatus("Recording... Do not close tab.");
        els.dlBtn.classList.add('recording');
        els.dlBtn.disabled = true;
        
        // Start Real-time recording
        recorder.start();
        Tone.Transport.stop();
        Tone.Transport.seconds = 0;
        Tone.Transport.start();

        // Wait for duration of song
        const durationMS = (midiData.duration * 1000) + 500; // add small buffer
        
        setTimeout(async () => {
            Tone.Transport.stop();
            const recording = await recorder.stop();
            
            els.dlBtn.classList.remove('recording');
            els.dlBtn.disabled = false;
            showStatus("Download starting...");
            
            // Trigger Download (WebM/WAV depending on browser)
            const url = URL.createObjectURL(recording);
            const anchor = document.createElement("a");
            anchor.download = `project_export_${Date.now()}.webm`;
            anchor.href = url;
            anchor.click();
            
            showStatus("Export complete.");
        }, durationMS);
    });

    function showStatus(msg) {
        const el = document.getElementById('status-overlay');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }

</script>

</body>
</html>
