<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced MIDI to MP3</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #2c3e50; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #34495e; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 450px; }
        h1 { margin-top: 0; text-align: center; font-size: 1.5rem; margin-bottom: 1.5rem; }
        
        .control-group { background: #2c3e50; padding: 15px; border-radius: 8px; margin-bottom: 1rem; }
        .control-group h3 { margin: 0 0 10px 0; font-size: 0.9rem; text-transform: uppercase; color: #bdc3c7; letter-spacing: 1px; }
        
        label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
        input[type="file"] { display: block; width: 100%; padding: 0.5rem; background: #ecf0f1; color: #333; border-radius: 4px; border: none; margin-top: 5px;}
        
        input[type="range"] { width: 100%; cursor: pointer; }
        select { width: 100%; padding: 8px; border-radius: 4px; border: none; margin-bottom: 10px; }

        .val-display { font-weight: bold; color: #3498db; }

        button { background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; width: 100%; margin-top: 10px; }
        button:hover { background: #2ecc71; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }

        #status { margin-top: 1rem; text-align: center; font-size: 0.9rem; color: #ecf0f1; min-height: 1.2em; }
        .download-link { display: block; text-align: center; background: #e67e22; color: white; text-decoration: none; padding: 10px; border-radius: 6px; margin-top: 15px; }
    </style>
    
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
</head>
<body>

<div class="container">
    <h1>MIDI Studio Converter</h1>

    <div class="control-group">
        <h3>1. File</h3>
        <input type="file" id="midiInput" accept=".mid,.midi">
    </div>

    <div class="control-group">
        <h3>2. Synthesis</h3>
        <label>Waveform (Instrument)</label>
        <select id="waveType">
            <option value="triangle">Triangle (Retro/Soft)</option>
            <option value="square">Square (Nintendo/Gameboy)</option>
            <option value="sawtooth">Sawtooth (Techno/Sharp)</option>
            <option value="sine">Sine (Whistle/Smooth)</option>
        </select>

        <label>Reverb (Room Size) <span id="reverbVal" class="val-display">20%</span></label>
        <input type="range" id="reverbInput" min="0" max="1" step="0.1" value="0.2">
    </div>

    <div class="control-group">
        <h3>3. Modifiers</h3>
        <label>Speed <span id="speedVal" class="val-display">1.0x</span></label>
        <input type="range" id="speedInput" min="0.5" max="2.0" step="0.1" value="1.0">

        <label style="margin-top:10px">Pitch Shift (Semitones) <span id="pitchVal" class="val-display">0</span></label>
        <input type="range" id="pitchInput" min="-12" max="12" step="1" value="0">
    </div>

    <button id="convertBtn" disabled>Render MP3</button>
    
    <div id="status"></div>
    <div id="download-area"></div>
</div>

<script>
    const midiInput = document.getElementById('midiInput');
    const convertBtn = document.getElementById('convertBtn');
    const statusDiv = document.getElementById('status');
    const downloadArea = document.getElementById('download-area');
    
    // Inputs
    const speedInput = document.getElementById('speedInput');
    const pitchInput = document.getElementById('pitchInput');
    const reverbInput = document.getElementById('reverbInput');
    const waveSelect = document.getElementById('waveType');

    // Displays
    const speedVal = document.getElementById('speedVal');
    const pitchVal = document.getElementById('pitchVal');
    const reverbVal = document.getElementById('reverbVal');

    let midiData = null;

    // UI Updaters
    speedInput.oninput = (e) => speedVal.innerText = e.target.value + 'x';
    pitchInput.oninput = (e) => pitchVal.innerText = (e.target.value > 0 ? '+' : '') + e.target.value;
    reverbInput.oninput = (e) => reverbVal.innerText = Math.round(e.target.value * 100) + '%';

    midiInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            midiData = new Midi(e.target.result);
            convertBtn.disabled = false;
            statusDiv.textContent = `Loaded "${midiData.name || file.name}"`;
            downloadArea.innerHTML = '';
        };
        reader.readAsArrayBuffer(file);
    });

    convertBtn.addEventListener('click', async () => {
        if (!midiData) return;

        convertBtn.disabled = true;
        statusDiv.textContent = "Synthesizing...";

        // Gather Settings
        const speed = parseFloat(speedInput.value);
        const pitchShift = parseInt(pitchInput.value); // Semitones
        const reverbAmt = parseFloat(reverbInput.value);
        const waveType = waveSelect.value;

        const originalDuration = midiData.duration;
        const adjustedDuration = originalDuration / speed;

        // --- TONE.JS OFFLINE RENDERING ---
        const audioBuffer = await Tone.Offline(({ transport }) => {
            
            // 1. Create Reverb Effect
            const reverb = new Tone.Reverb({
                decay: 2.0,
                wet: reverbAmt 
            }).toDestination();
            
            // 2. Create Synthesizer and connect to Reverb
            const synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: waveType },
                envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
            }).connect(reverb);

            // 3. Schedule Notes
            midiData.tracks.forEach(track => {
                track.notes.forEach(note => {
                    
                    // Adjust Speed
                    const startTime = note.time / speed;
                    const duration = note.duration / speed;

                    // Adjust Pitch
                    // Tone.Frequency(note.name).transpose(val) returns a frequency object
                    // note.name is something like "C4". 
                    const transposedNote = Tone.Frequency(note.name).transpose(pitchShift);

                    transport.schedule(() => {
                        synth.triggerAttackRelease(transposedNote, duration, undefined, note.velocity);
                    }, startTime);
                });
            });

            transport.start();

        }, adjustedDuration + 2); // +2 seconds for reverb tail

        statusDiv.textContent = "Encoding to MP3...";
        
        setTimeout(() => {
            encodeMp3(audioBuffer);
        }, 50);
    });

    function encodeMp3(buffer) {
        // LameJS setup
        const channels = 2;
        const sampleRate = buffer.sampleRate;
        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 192); // Increased to 192kbps
        
        const leftData = buffer.getChannelData(0);
        const rightData = buffer.getChannelData(1);
        const sampleBlockSize = 1152;
        const mp3Data = [];
        
        const leftInt16 = convertFloatToInt16(leftData);
        const rightInt16 = convertFloatToInt16(rightData);

        for (let i = 0; i < leftInt16.length; i += sampleBlockSize) {
            const leftChunk = leftInt16.subarray(i, i + sampleBlockSize);
            const rightChunk = rightInt16.subarray(i, i + sampleBlockSize);
            const mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
            if (mp3buf.length > 0) mp3Data.push(mp3buf);
        }
        
        const mp3buf = mp3encoder.flush();
        if (mp3buf.length > 0) mp3Data.push(mp3buf);

        const blob = new Blob(mp3Data, { type: 'audio/mp3' });
        const url = window.URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.className = 'download-link';
        link.href = url;
        link.download = `converted_${Date.now()}.mp3`;
        link.innerText = "Download MP3";
        
        downloadArea.appendChild(link);
        statusDiv.textContent = "Done!";
        convertBtn.disabled = false;
    }

    function convertFloatToInt16(float32Array) {
        const len = float32Array.length;
        const int16Array = new Int16Array(len);
        for (let i = 0; i < len; i++) {
            let s = Math.max(-1, Math.min(1, float32Array[i]));
            s = s < 0 ? s * 0x8000 : s * 0x7FFF;
            int16Array[i] = s;
        }
        return int16Array;
    }
</script>

</body>
</html>