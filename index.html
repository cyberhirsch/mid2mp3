<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal MIDI Studio (Robust)</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #2c3e50; 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
            box-sizing: border-box;
        }
        .container { 
            background: #34495e; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            width: 500px; 
            max-width: 100%;
        }
        h1 { margin-top: 0; text-align: center; color: #ecf0f1; margin-bottom: 0.5rem; }
        .subtitle { text-align: center; color: #bdc3c7; font-size: 0.9rem; margin-bottom: 1.5rem; font-style: italic;}
        
        .control-group { 
            background: #2c3e50; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            border: 1px solid #3e5871;
        }
        .control-group h3 { 
            margin: 0 0 10px 0; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            color: #bdc3c7; 
            letter-spacing: 1px; 
        }

        /* File Input Row */
        .file-row { display: flex; gap: 10px; align-items: center; }
        input[type="file"] { flex: 1; padding: 0.5rem; background: #ecf0f1; color: #333; border-radius: 4px; border: none; }
        
        /* Small Action Button */
        .action-btn { 
            padding: 0 15px; height: 36px; background: #3498db; color: white; border: none; border-radius: 4px; 
            font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .action-btn:hover { background: #2980b9; }

        #track-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 10px;
        }
        #track-list::-webkit-scrollbar { width: 6px; }
        #track-list::-webkit-scrollbar-thumb { background: #7f8c8d; border-radius: 3px; }

        .track-row {
            display: flex;
            align-items: center;
            background: #3e5871;
            margin-bottom: 6px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .track-info { flex: 1; padding-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .track-select { width: 140px; padding: 4px; border: none; border-radius: 3px; font-size: 0.8rem; }
        
        label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
        input[type="range"] { width: 100%; cursor: pointer; margin-bottom: 10px; }
        .val-display { font-weight: bold; color: #3498db; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }

        .big-btn { 
            color: white; border: none; padding: 12px; border-radius: 6px; 
            cursor: pointer; font-weight: bold; font-size: 1rem; flex: 1;
            transition: opacity 0.2s;
        }
        
        #playBtn { background: #e67e22; }
        #playBtn:hover { background: #d35400; }
        
        #convertBtn { background: #27ae60; }
        #convertBtn:hover { background: #2ecc71; }
        
        button:disabled { background: #7f8c8d !important; cursor: not-allowed; opacity: 0.7; }

        #status { 
            margin-top: 1rem; text-align: center; color: #ecf0f1; min-height: 1.2em; font-size: 0.9rem;
            white-space: pre-wrap; word-break: break-word;
        }
        .error-text { color: #e74c3c; font-weight: bold; }
        
        .download-link { 
            display: block; text-align: center; background: #e67e22; color: white; text-decoration: none; 
            padding: 12px; border-radius: 6px; margin-top: 15px; font-weight: bold; 
        }
    </style>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/tone@13.8.25/build/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Universal MIDI Studio</h1>
    <div class="subtitle">Preview & Render</div>

    <div class="control-group">
        <h3>1. File</h3>
        <div class="file-row">
            <input type="file" id="midiInput" accept=".mid,.midi">
            <button id="loadBtn" class="action-btn">Load</button>
        </div>
    </div>

    <div class="control-group" id="tracks-group" style="display:none;">
        <h3>2. Instruments</h3>
        <div id="track-list"></div>
    </div>

    <div class="control-group">
        <h3>3. Settings</h3>
        <label>Target Tempo (BPM) <span id="bpmVal" class="val-display">120</span></label>
        <input type="range" id="bpmInput" min="40" max="240" step="1" value="120">

        <label>Pitch Shift <span id="pitchVal" class="val-display">0</span></label>
        <input type="range" id="pitchInput" min="-12" max="12" step="1" value="0">

        <label>Reverb <span id="reverbVal" class="val-display">10%</span></label>
        <input type="range" id="reverbInput" min="0" max="0.8" step="0.05" value="0.1">
    </div>

    <div class="btn-row">
        <button id="playBtn" class="big-btn" disabled>▶ Play Preview</button>
        <button id="convertBtn" class="big-btn" disabled>★ Render MP3</button>
    </div>
    
    <div id="status">Waiting for file...</div>
    <div id="download-area"></div>
</div>

<script>
    // -- Global Error Handler (In case Scripts fail to load) --
    window.onerror = function(msg, url, line) {
        document.getElementById('status').innerHTML = `<span class="error-text">System Error: ${msg}<br>Check internet connection for Tone.js</span>`;
        return false;
    };

    // -- Elements --
    const midiInput = document.getElementById('midiInput');
    const loadBtn = document.getElementById('loadBtn');
    const playBtn = document.getElementById('playBtn');
    const convertBtn = document.getElementById('convertBtn');
    const statusDiv = document.getElementById('status');
    const downloadArea = document.getElementById('download-area');
    const trackListDiv = document.getElementById('track-list');
    const tracksGroup = document.getElementById('tracks-group');
    
    // Controls
    const bpmInput = document.getElementById('bpmInput');
    const pitchInput = document.getElementById('pitchInput');
    const reverbInput = document.getElementById('reverbInput');
    const bpmVal = document.getElementById('bpmVal');
    const pitchVal = document.getElementById('pitchVal');
    const reverbVal = document.getElementById('reverbVal');

    // -- State --
    let midiData = null;
    let originalBpm = 120;
    let isPlaying = false;
    let activeSynths = [];

    const INSTRUMENTS = [
        { val: 'triangle', label: 'Triangle (Soft)' },
        { val: 'square', label: 'Square (Retro)' },
        { val: 'sawtooth', label: 'Sawtooth (Sharp)' },
        { val: 'sine', label: 'Sine (Smooth)' },
        { val: 'membrane', label: 'Membrane (Drums)' }
    ];

    // -- UI Updates --
    pitchInput.oninput = (e) => pitchVal.innerText = (e.target.value > 0 ? '+' : '') + e.target.value;
    reverbInput.oninput = (e) => reverbVal.innerText = Math.round(e.target.value * 100) + '%';
    bpmInput.oninput = (e) => bpmVal.innerText = e.target.value;

    // -- LOAD LOGIC --
    function processFile(file) {
        if (!file) return;
        
        // Stop playback if running
        if (isPlaying) stopPlayback();

        statusDiv.textContent = "Parsing MIDI...";
        statusDiv.className = "";
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // Ensure Tone/Midi loaded
                if (typeof Midi === 'undefined') throw new Error("Midi parser library not loaded.");
                
                midiData = new Midi(e.target.result);
                setupMidiUI(file.name);
            } catch (err) {
                statusDiv.innerHTML = `<span class="error-text">Error: ${err.message}</span>`;
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // 1. Listen for file select
    midiInput.addEventListener('change', (e) => processFile(e.target.files[0]));
    
    // 2. Listen for manual load button (fixes "stuck" inputs)
    loadBtn.addEventListener('click', () => {
        if(midiInput.files.length > 0) {
            processFile(midiInput.files[0]);
        } else {
            midiInput.click(); // Open dialog if empty
        }
    });

    // 3. Auto-check on page load (fixes browser auto-fill)
    window.addEventListener('load', () => {
        if(midiInput.files.length > 0) {
            processFile(midiInput.files[0]);
        }
    });

    function setupMidiUI(filename) {
        if (midiData.header.tempos.length > 0) {
            originalBpm = Math.round(midiData.header.tempos[0].bpm);
        } else {
            originalBpm = 120;
        }

        bpmInput.value = originalBpm;
        bpmVal.innerText = originalBpm;
        
        trackListDiv.innerHTML = '';
        tracksGroup.style.display = 'block';

        midiData.tracks.forEach((track, index) => {
            if (track.notes.length === 0) return;

            const row = document.createElement('div');
            row.className = 'track-row';

            let defaultInst = 'triangle';
            if (track.instrument.percussion || track.channel === 9) { 
                defaultInst = 'membrane'; 
            } else if (track.instrument.family === 'bass') {
                defaultInst = 'sawtooth';
            } else if (track.instrument.family === 'piano') {
                defaultInst = 'square';
            }

            let optionsHtml = INSTRUMENTS.map(inst => 
                `<option value="${inst.val}" ${inst.val === defaultInst ? 'selected' : ''}>${inst.label}</option>`
            ).join('');

            row.innerHTML = `
                <div class="track-info">
                    <strong>${index + 1}.</strong> ${track.name || track.instrument.name || 'Track ' + (index+1)}
                </div>
                <select class="track-select" id="inst-select-${index}">
                    ${optionsHtml}
                </select>
            `;
            trackListDiv.appendChild(row);
        });

        playBtn.disabled = false;
        convertBtn.disabled = false;
        statusDiv.textContent = `Loaded: ${filename}`;
        downloadArea.innerHTML = '';
    }

    // -- SCHEDULING LOGIC (Shared) --
    function scheduleTracks(transport, destination) {
        const targetBpm = parseInt(bpmInput.value);
        const safeOriginalBpm = originalBpm > 0 ? originalBpm : 120;
        const speedRatio = targetBpm / safeOriginalBpm;
        
        const pitchShift = parseInt(pitchInput.value);
        const reverbAmt = parseFloat(reverbInput.value);

        // Tone v13 Reverb
        const reverb = new Tone.Freeverb({
            roomSize: reverbAmt,
            dampening: 3000
        }).connect(destination);

        const synthsCreated = [];

        midiData.tracks.forEach((track, index) => {
            if (track.notes.length === 0) return;

            const selectEl = document.getElementById(`inst-select-${index}`);
            if (!selectEl) return;
            const instType = selectEl.value;

            let synth;
            if (instType === 'membrane') {
                synth = new Tone.PolySynth(4, Tone.MembraneSynth);
                synth.set({ volume: -5, octaves: 2, pitchDecay: 0.05 });
            } else {
                synth = new Tone.PolySynth(6, Tone.Synth);
                synth.set({
                    oscillator: { type: instType },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 },
                    volume: -8
                });
            }

            synth.connect(reverb);
            synthsCreated.push(synth);

            track.notes.forEach(note => {
                let startTime = note.time / speedRatio;
                let duration = note.duration / speedRatio;
                
                if (duration <= 0) duration = 0.1;
                if (startTime < 0) startTime = 0;

                transport.schedule((time) => {
                    if (instType === 'membrane') {
                         synth.triggerAttackRelease(note.name, duration, time, note.velocity);
                    } else {
                        try {
                            const transposed = Tone.Frequency(note.name).transpose(pitchShift);
                            synth.triggerAttackRelease(transposed, duration, time, note.velocity);
                        } catch(e) {}
                    }
                }, startTime);
            });
        });

        return synthsCreated;
    }

    // -- PLAY PREVIEW --
    playBtn.addEventListener('click', async () => {
        if (isPlaying) {
            stopPlayback();
            return;
        }

        // Initialize Audio Context (Required for browsers)
        if (Tone.context.state !== 'running') {
            await Tone.context.resume();
        }

        statusDiv.textContent = "Playing...";
        playBtn.textContent = "■ Stop";
        playBtn.style.background = "#c0392b";
        
        activeSynths = scheduleTracks(Tone.Transport, Tone.Master);
        Tone.Transport.start();
        isPlaying = true;
    });

    function stopPlayback() {
        Tone.Transport.stop();
        Tone.Transport.cancel();
        activeSynths.forEach(s => s.dispose());
        activeSynths = [];
        isPlaying = false;
        playBtn.textContent = "▶ Play Preview";
        playBtn.style.background = "#e67e22";
        statusDiv.textContent = "Stopped.";
    }

    // -- RENDER MP3 --
    convertBtn.addEventListener('click', () => {
        if (!midiData) return;
        if (isPlaying) stopPlayback();
        
        convertBtn.disabled = true;
        playBtn.disabled = true;
        downloadArea.innerHTML = '';

        const targetBpm = parseInt(bpmInput.value);
        const safeOriginalBpm = originalBpm > 0 ? originalBpm : 120;
        const speedRatio = targetBpm / safeOriginalBpm;
        const adjustedDuration = (midiData.duration / speedRatio) + 1.0; 

        statusDiv.textContent = "Synthesizing... (Please wait)";

        // Tone.js v13 Offline Rendering
        Tone.Offline(function(Transport) {
            scheduleTracks(Transport, Tone.Master);
            Transport.start();
        }, adjustedDuration).then(function(buffer) {
            statusDiv.textContent = "Encoding MP3...";
            setTimeout(() => encodeMp3(buffer), 50);
        }).catch(function(err){
            console.error(err);
            statusDiv.innerHTML = `<span class="error-text">Render Error: ${err}</span>`;
            convertBtn.disabled = false;
            playBtn.disabled = false;
        });
    });

    function encodeMp3(buffer) {
        try {
            const channels = 2;
            const sampleRate = buffer.sampleRate;
            const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 128);
            
            const leftData = buffer.getChannelData(0);
            const rightData = buffer.getChannelData(1);
            const leftInt16 = convertFloatToInt16(leftData);
            const rightInt16 = convertFloatToInt16(rightData);
            
            const blockSize = 1152;
            const mp3Data = [];
            
            for (let i = 0; i < leftInt16.length; i += blockSize) {
                const l = leftInt16.subarray(i, i + blockSize);
                const r = rightInt16.subarray(i, i + blockSize);
                const mp3buf = mp3encoder.encodeBuffer(l, r);
                if (mp3buf.length > 0) mp3Data.push(mp3buf);
            }
            
            const endBuf = mp3encoder.flush();
            if (endBuf.length > 0) mp3Data.push(endBuf);

            const blob = new Blob(mp3Data, { type: 'audio/mp3' });
            const url = window.URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.className = 'download-link';
            link.href = url;
            link.download = `rendered_${Date.now()}.mp3`;
            link.innerText = "Download MP3";
            
            downloadArea.appendChild(link);
            statusDiv.textContent = "Render Complete!";
        } catch(e) {
            statusDiv.innerHTML = `<span class="error-text">Encoding Error: ${e.message}</span>`;
        } finally {
            convertBtn.disabled = false;
            playBtn.disabled = false;
        }
    }

    function convertFloatToInt16(float32Array) {
        const l = float32Array.length;
        const res = new Int16Array(l);
        for (let i = 0; i < l; i++) {
            let s = Math.max(-1, Math.min(1, float32Array[i]));
            res[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return res;
    }
</script>

</body>
</html>
